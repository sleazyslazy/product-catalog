apiVersion: tekton.dev/v1
kind: Task
metadata:
  namespace: product-catalog-cicd
spec:
  description: |-
    Generates an identifier that can be used to uniquely identify a build.
    The build identifier that is generated is a composite of the short commit hash from the source code repository plus a UUID generated by ksuid. ksuid generates date sortable UUIDs that can be reversed into a date representation.
  results:
    - description: The short commit SHA that was fetched by this Task
      name: short_commit
      type: string
    - description: Unique build identifier
      name: build_uid
      type: string
    - description: Unique tag identifier
      name: tag_id
      type: string
  stepTemplate:
    computeResources: {}
    env:
      - name: HOME
        value: /tekton/home
  steps:
    - computeResources: {}
      image: 'quay.io/gnunn/tools:latest'
      name: generate
      script: |
        #!/usr/bin/env sh

        # Make safe directory
        git config --global --add safe.directory /workspace/source

        # Get short commit
        export SHORT_SHA=$(git rev-parse --short HEAD)
        echo -n "$SHORT_SHA" > $(results.short_commit.path)

        # Generate uinque UID
        #export BUILD_UID=$(printf '%s ' $(date) | cksum | cut -f -1 -d ' ')
        export BUILD_UID=$(ksuid)
        echo -n "$BUILD_UID" > $(results.build_uid.path)

        echo -n "$SHORT_SHA-$BUILD_UID" > $(results.tag_id.path)

        echo "Generated ID $SHORT_SHA-$BUILD_UID"
      workingDir: $(workspaces.source.path)
  workspaces:
    - name: source
